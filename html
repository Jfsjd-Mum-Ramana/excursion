import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.*;
import org.mockito.junit.MockitoJUnitRunner;

import java.io.InputStream;
import java.io.OutputStream;
import java.util.*;

import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.Mockito.*;

@RunWith(MockitoJUnitRunner.class)
public class SSHServiceTest {

    @Mock
    private KafkaProducerService kafkaProducerService;

    @Mock
    private ChannelSftp channelSftp;

    @Mock
    private OutputStreamCreator outputStreamCreator;

    @Mock
    private CollectionAuditRepository collectionAuditRepository;

    @Mock
    private CollectorUtil collectorUtil;

    @Mock
    private S3Service s3Service;

    @InjectMocks
    private SSHService sshService; // Your service class

    @Before
    public void setUp() {
        MockitoAnnotations.openMocks(this); // Initialize mocks
    }

    @Test
    public void testRetrieveData_Success() throws Exception {
        when(kafkaProducerService.writeMessage(Mockito.any(), anyString(), anyString())).thenReturn(true);

        InputStream mockInputStream = mock(InputStream.class);
        when(channelSftp.get(anyString())).thenReturn(mockInputStream);

        OutputStream mockOutputStream = mock(OutputStream.class);
        when(outputStreamCreator.create(anyString())).thenReturn(mockOutputStream);

        when(mockInputStream.read(ArgumentMatchers.any(byte[].class))).thenReturn(-1); // Simulate end of stream
        doNothing().when(mockOutputStream).close();
        doNothing().when(mockInputStream).close();

        Vector<ChannelSftp.LsEntry> files = new Vector<>();
        for (String fileName : new String[]{"Sample1.csv", "Sample2.csv", "Sample3.csv"}) {
            ChannelSftp.LsEntry file = mock(ChannelSftp.LsEntry.class);
            SftpATTRS attrs = mock(SftpATTRS.class);
            when(file.getFilename()).thenReturn(fileName);
            when(file.getAttrs()).thenReturn(attrs);
            when(attrs.isDir()).thenReturn(false);
            files.add(file);
        }
        when(channelSftp.ls(anyString())).thenReturn(files);

        List<CollectionAudit> audits = new ArrayList<>();
        for (String fileName : new String[]{"/path/to/input/Sample1.csv", "/path/to/input/Sample3.csv"}) {
            CollectionAudit audit = mock(CollectionAudit.class);
            when(audit.getInputFilePath()).thenReturn(fileName);
            when(audit.getJobStatus()).thenReturn(fileName.equals("/path/to/input/Sample1.csv") ? "COLLECTION_FAILED" : "COLLECTION_SUCCESS");
            audits.add(audit);
        }
        doReturn(audits).when(collectionAuditRepository).findLatestByFilePaths(anyList());

        SpaceCollector spaceCollector = new SpaceCollector();
        spaceCollector.setUrl("localhost");
        spaceCollector.setPort(22);
        spaceCollector.setUserName("username");
        spaceCollector.setPassword("password");
        spaceCollector.setInputFilePath("/path/to/input");
        spaceCollector.setOutputFilePath("/path/to/output");

        when(collectorUtil.getDateAsString(Mockito.any())).thenReturn("2021-01-01");

        boolean result = sshService.retrieveData(spaceCollector, collectorUtil.getDateAsString(new Date()), "3459-DEV-COLLECTION-AUDIT-QUEUE");

        verify(channelSftp, times(2)).get(anyString());
    }

    @Test
    public void testRetrieveData_FileRetrievalFailureForSpecificFile() throws Exception {
        InputStream mockInputStream = mock(InputStream.class);
        when(channelSftp.get(anyString())).thenReturn(mockInputStream);
        when(channelSftp.get("/path/to/input/Sample2.csv")).thenThrow(new SftpException(0, "file retrieval failed"));

        OutputStream mockOutputStream = mock(OutputStream.class);
        when(outputStreamCreator.create(anyString())).thenReturn(mockOutputStream);

        when(mockInputStream.read(ArgumentMatchers.any(byte[].class))).thenReturn(-1); // Simulate end of stream
        doNothing().when(mockOutputStream).close();
        doNothing().when(mockInputStream).close();

        Vector<ChannelSftp.LsEntry> files = new Vector<>();
        for (String fileName : new String[]{"Sample1.csv", "Sample2.csv", "Sample3.csv"}) {
            ChannelSftp.LsEntry file = mock(ChannelSftp.LsEntry.class);
            SftpATTRS attrs = mock(SftpATTRS.class);
            when(file.getFilename()).thenReturn(fileName);
            when(file.getAttrs()).thenReturn(attrs);
            when(attrs.isDir()).thenReturn(false);
            files.add(file);
        }
        when(channelSftp.ls(anyString())).thenReturn(files);

        List<CollectionAudit> audits = new ArrayList<>();
        for (String fileName : new String[]{"/path/to/input/Sample1.csv", "/path/to/input/Sample3.csv"}) {
            CollectionAudit audit = mock(CollectionAudit.class);
            when(audit.getInputFilePath()).thenReturn(fileName);
            when(audit.getJobStatus()).thenReturn(fileName.equals("/path/to/input/Sample1.csv") ? "COLLECTION_FAILED" : "COLLECTION_SUCCESS");
            audits.add(audit);
        }
        doReturn(audits).when(collectionAuditRepository).findLatestByFilePaths(anyList());

        SpaceCollector spaceCollector = new SpaceCollector();
        spaceCollector.setUrl("localhost");
        spaceCollector.setPort(22);
        spaceCollector.setUserName("username");
        spaceCollector.setPassword("password");
        spaceCollector.setInputFilePath("/path/to/input");
        spaceCollector.setOutputFilePath("/path/to/output");

        boolean result = sshService.retrieveData(spaceCollector, collectorUtil.getDateAsString(new Date()), "3459-DEV-COLLECTION-AUDIT-QUEUE");

        verify(channelSftp, times(2)).get(anyString());
    }
}
