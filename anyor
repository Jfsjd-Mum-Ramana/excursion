package com.verizon.ucs.service.pulsar;

import com.verizon.ucs.config.VMBProperties;
import org.apache.pulsar.client.api.PulsarClient;
import org.apache.pulsar.client.api.PulsarClientException;
import org.apache.pulsar.client.impl.auth.AuthenticationTls;
import org.apache.pulsar.shade.client.api.v2.Producer;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.stereotype.Service;

@Service
@EnableConfigurationProperties({ VMBProperties.class })
public class PulsarPublisherService {

    @Autowired
    private VMBProperties properties;

    public void publishMessage(String message) throws PulsarClientException {
        org.apache.pulsar.shade.client.api.v2.PulsarClient client = PulsarClient.builder()
                .serviceUrl(properties.getServiceUrl())
                .tlsTrustCertsFilePath(properties.getTlsTrustCertsFile())
                .authentication(new AuthenticationTls(properties.getTlsCertFile(), properties.getTlsKeyFile()))
                .build();

        Producer<byte[]> producer = client.newProducer()
                .topic(properties.getTopicName())
                .create();

        producer.send(message.getBytes());

        producer.close();
        client.close();
    }
}
