package com.verizon.ucs.restapi.repository;

import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;
import org.springframework.data.repository.CrudRepository;

import java.util.List;
import java.time.LocalDateTime;

@Repository
public interface UCSPAlarmRepository extends CrudRepository<Object[], Long> {

    // Query to get scatter plot data based on protocol and date range
    @Query(value = """
        SELECT 
            m.collection_name, 
            m.last_updated AS date, 
            CASE 
                WHEN :dataType = 'number_of_msgs' THEN m.number_of_msgs 
                WHEN :dataType = 'size_of_msgs' THEN m.size_of_msgs 
                ELSE NULL 
            END AS y_value
        FROM ucsp_alarm_metrics m
        JOIN ucsp_alarm_inventory i ON m.collection_name = i.collection_name
        WHERE i.ucg_source = :protocol
          AND m.last_updated BETWEEN :startDate AND :endDate
        """, nativeQuery = true)
    List<Object[]> findScatterPlotData(String protocol, String dataType, LocalDateTime startDate, LocalDateTime endDate);

    // Query to filter data by protocol
    @Query(value = """
        SELECT 
            m.collection_name, 
            m.last_updated AS date, 
            m.number_of_msgs, 
            m.size_of_msgs
        FROM ucsp_alarm_metrics m
        JOIN ucsp_alarm_inventory i ON m.collection_name = i.collection_name
        WHERE i.ucg_source = :protocol
        """, nativeQuery = true)
    List<Object[]> findByProtocol(String protocol);

    // Query to get all available protocols
    @Query(value = "SELECT DISTINCT ucg_source FROM ucsp_alarm_inventory", nativeQuery = true)
    List<String> findAllProtocols();
}