CREATE OR REPLACE FUNCTION eclipse.delete_hpov_s2im_transactions()
RETURNS json
LANGUAGE plpgsql
AS $$
DECLARE
    transactions_deleted_count INT;
    devices_audit_deleted_count INT;
    err_context TEXT;
BEGIN
    -- Delete old records from hpov_s2im_transactions
    DELETE FROM hpov_s2im_transactions WHERE collected_time < NOW() - INTERVAL '7 days';
    GET DIAGNOSTICS transactions_deleted_count = ROW_COUNT;

    -- Delete old records from hpov_s2im_devices_audit
    DELETE FROM hpov_s2im_devices_audit WHERE update_timestamp < NOW() - INTERVAL '7 days';
    GET DIAGNOSTICS devices_audit_deleted_count = ROW_COUNT;

    -- Return deletion summary
    RETURN json_build_object(
        'status', 'Transactions Deleted Successfully',
        'transactions_deleted_count', transactions_deleted_count,
        'devices_audit_deleted_count', devices_audit_deleted_count
    );
EXCEPTION
    WHEN OTHERS THEN
        -- Capture exception details
        GET STACKED DIAGNOSTICS err_context = PG_EXCEPTION_CONTEXT;
        RETURN json_build_object(
            'status', 'Transactions Failed to Delete',
            'error', SQLERRM,
            'context', err_context
        );
END;
$$;



This is the function I have done according to this cnage the code will work properly
