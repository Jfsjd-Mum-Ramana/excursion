import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.io.ClassPathResource;
import org.springframework.util.FileCopyUtils;
import com.jcraft.jsch.*;

import java.io.IOException;
import java.nio.charset.StandardCharsets;

@Configuration
public class SSHConfig {

    @Value("${ssh.publicKeyPath}")
    private String publicKeyPath;

    // Other configurations...

    @Bean
    public Session sshSession() {
        JSch jsch = new JSch();
        Session session = null;

        try {
            // Handle unknown host key
            JSch.setConfig("StrictHostKeyChecking", "no");

            // Read the public key file from the resources directory
            ClassPathResource resource = new ClassPathResource(publicKeyPath);
            byte[] publicKeyBytes = FileCopyUtils.copyToByteArray(resource.getInputStream());
            String publicKey = new String(publicKeyBytes, StandardCharsets.UTF_8);

            // Add the public key for authentication
            jsch.addIdentity("mykey", publicKey.getBytes(), null, null);

            // Set up the SSH session
            session = jsch.getSession(sshUsername, sshHost);
            session.setConfig("PreferredAuthentications", "publickey");
            session.connect();
        } catch (JSchException | IOException e) {
            e.printStackTrace();
        }

        return session;
    }
}
