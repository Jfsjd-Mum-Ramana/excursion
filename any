package org.vdsi.space.collections.customauditengine.controllers;

import com.amazonaws.services.s3.AmazonS3;
import com.amazonaws.services.s3.model.S3Object;
import com.amazonaws.services.s3.model.S3ObjectInputStream;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.MediaType;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import java.io.IOException;
import java.io.OutputStream;

@RestController
public class S3Controller {

    private final AmazonS3 s3Client;

    @Autowired
    public S3Controller(AmazonS3 s3Client) {
        this.s3Client = s3Client;
    }

    @GetMapping(value = "/s3download", produces = MediaType.APPLICATION_OCTET_STREAM_VALUE)
    public void downloadFile(@RequestParam String bucketName,
                             @RequestParam String key,
                             HttpServletResponse response) throws IOException {
        String fileName = key.substring(key.lastIndexOf("/") + 1);

        S3Object s3Object = s3Client.getObject(bucketName, key);
        try (S3ObjectInputStream inputStream = s3Object.getObjectContent()) {
            response.setHeader("Content-Disposition", "attachment; filename=" + fileName);
            response.setHeader("Content-Length", String.valueOf(s3Object.getObjectMetadata().getContentLength()));

            try (OutputStream outputStream = response.getOutputStream()) {
                int len;
                byte[] buffer = new byte[4096];
                while ((len = inputStream.read(buffer, 0, buffer.length)) != -1) {
                    outputStream.write(buffer, 0, len);
                }
                outputStream.flush();
            }
        }
    }
}
