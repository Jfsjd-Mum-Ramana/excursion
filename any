Feature: Downloading files from S3 Bucket

  Scenario: Downloading a file successfully
    When the file is downloaded
    Then the response should contain the file content "test"
    And the response header "Content-Length" should be "5"
  
  Scenario: Handling IOException from S3 service
    When the file is downloaded
    Then an IOException should be thrown

  Scenario: Partially reading a file from S3
    When the file is downloaded
    Then the response should contain the file content "te"
    And the response header "Content-Length" should be "2"





package org.vdsi.space.collections.customauditengine.controllers;

import io.cucumber.java.en.Then;
import io.cucumber.java.en.When;
import org.junit.jupiter.api.Assertions;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.mock.web.MockHttpServletResponse;
import org.springframework.test.context.ContextConfiguration;

import java.io.ByteArrayInputStream;
import java.io.IOException;

import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;

@ContextConfiguration(classes = S3Controller.class)
public class S3ControllerGlue {

    @Autowired
    private S3Controller s3Controller;

    private MockHttpServletResponse response;

    @When("the file is downloaded")
    public void the_file_is_downloaded() throws IOException {
        response = new MockHttpServletResponse();
        s3Controller.downloadFile("bucket-name", "key/file.txt", response);
    }

    @Then("the response should contain the file content {string}")
    public void the_response_should_contain_the_file_content(String content) throws IOException {
        Assertions.assertEquals(content, response.getContentAsString());
    }

    @Then("the response header {string} should be {string}")
    public void the_response_header_should_be(String headerName, String headerValue) {
        Assertions.assertEquals(headerValue, response.getHeader(headerName));
    }

    @Then("an IOException should be thrown")
    public void an_ioexception_should_be_thrown() {
        Assertions.assertThrows(IOException.class, () -> {
            s3Controller.downloadFile("bucket-name", "key/file.txt", response);
        });
    }
}
